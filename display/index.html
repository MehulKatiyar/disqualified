<html>
<head>
  <title>test Ws mqtt.js</title>
 <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
 <script src="./browserMqtt.js"></script>
 <script src="./davidshimjs-qrcodejs-540308a/qrcode.min.js"></script>
<script>
 
// $(window).bind('beforeunload',function(){
// 	//return 'are you sure you want to leave?';
// 	//publish to mqtt
	
// 		client.subscribe('presence');
//   	client.publish('presence', 'Hello mqtt');
	
// 	client.on('message', function (topic, message) {
//   	// message is Buffer
//   	console.log(message.toString());
//   	client.end();
// 	});
// });
</script>
<style type="text/css">
#imglist {
width: 200px;
margin: auto;
}
#imglist img {
display: none;
}
#imglist img.scaleup {
display: block;
/* position: absolute;
height: 150px;
-webkit-animation: popup 1s linear;
animation: popup 1s linear;
animation-delay: 200ms;
*/}
@-webkit-keyframes popup {
0% { bottom: -150px; }
20% { bottom: 30%; transform: scale(1.5); }
30% { bottom: 40%; transform: scale(2); }
60% { bottom: 50%; transform: scale(2.2); }
90% { bottom: 90%; transform: scale(1); }
100% { bottom: 100%; transform: scale(0.5); }
}
@keyframes popup {
0% { bottom: -150px; }
20% { bottom: 30%; transform: scale(1.5); }
30% { bottom: 40%; transform: scale(2); }
60% { bottom: 50%; transform: scale(2.2); }
90% { bottom: 90%; transform: scale(1); }
100% { bottom: 100%; transform: scale(0.5); }
}
</style>
</head>
<body>
	<div id="count" ></div>
	

	<div id="imglist">
    <span id="div1">
      <img class="1" src="images/Fly/1.jpg">
      <img class="2" src="images/Fly/2.png">
      <img class="3" src="images/Fly/3.png">
      <img class="4" src="images/Fly/4.png">
      <img class="5" src="images/Fly/5.jpg">
      <img class="6" src="images/Fly/6.jpg">
      <img class="7" src="images/Fly/7.png">
      <img class="8" src="images/Fly/8.png">
    </span>
    <span id="div2">
      <img class="1" src="images/NoFly/1.jpg">
      <img class="2" src="images/NoFly/2.gif">
      <img class="3" src="images/NoFly/3.jpg">
      <img class="4" src="images/NoFly/4.png">
      <img class="5" src="images/NoFly/5.png">
      <img class="6" src="images/NoFly/6.png">
      <img class="7" src="images/NoFly/7.png">
      <img class="8" src="images/NoFly/8.png">
    </span>
  </div>

  <div id="audio"></div>
  <audio id="player" controls="controls" style="display:none">
    <source id="mp3_src" src="audio/fly/1.mp3" type="audio/mp3" />
    Your browser does not support the audio element.
  </audio>

  <script type="text/javascript">
    function getUrlVars() {
			var vars = {};
			var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
					vars[key] = value;
			});
		return vars;
		}
    var id = getUrlVars()["id"];
    var client  = mqtt.connect("ws://saurabhk.housing.com:8083/mqtt");
    client.subscribe('/'+id+'/chat/fetch');
    client.subscribe('/'+id+'/chat/start');
    client.publish('/chat/'+id+'/init', 'publish for init', 1);
    client.publish('/chat/'+id+'/ready', 'publish for ready', 1);
    var global_msg;
    client.on('message', function (topic, message) {
    	//alert("m" + message)
      
    	//alert(topic+" "+'/'+id+'/chat/start')

      if(topic == '/'+id+'/chat/start'){
      	//alert(message);
      	//alert(global_msg);
      	 window.setTimeout(function(){
             
             render_image(global_msg);
       }, 400);
      	//render_image(global_msg);
    	}
    	else{
    		if(topic== '/'+id+'/chat/fetch'){
    			//alert(message)
    			message  = JSON.parse(message.toString());
    			global_msg = message;
    		}

    	}

      //alert(message)
    });
    
    function render_image(message) {
      //console.log(message)
      //alert('aman1')
      //var i = message.length
      call_fly_method(message,0)
      
      
    }

    function change_audio(fly, image_id) {
      var audio = $("#player");
      if (fly) {src = "audio/fly/"+image_id+".mp3"} else{src = "audio/no_fly/"+image_id+".mp3"};
      $("#mp3_src").attr("src", src);
      /****************/
      audio[0].pause();
      audio[0].load();//suspends and restores all audio element

      //audio[0].play(); changed based on Sprachprofi's comment below
      audio[0].oncanplaythrough = audio[0].play();
      /****************/
    }

    function call_fly_method(message, i, prev_img_id){
        if(i >= message.length) {
          round_end(i)
          return;
        };
        //alert(message+i)
       	$("#count").html(i+1+" : "+ message[i]%2 )
        if (message[i]%2 == 0) {
            image_id = rand(prev_img_id);
            change_audio(true, image_id);
            can_fly(image_id);
          }
          else{
            image_id = rand(prev_img_id);
            change_audio(false, image_id);
            cant_fly(image_id);
          };
          window.setTimeout(function(){
            // console.log(i);
            call_fly_method(message, ++i, image_id);
          }, 1000);
    }
    
    function can_fly (udd_id) {
      // console.log(udd_id)
      $('#div1 img').removeClass("scaleup");
      $('#div2 img').removeClass("scaleup");
      $('#div1 img.' + udd_id).addClass("scaleup");
    }
    
    function cant_fly (not_udd_id) {
      // console.log(not_udd_id)
      $('#div2 img').removeClass("scaleup");
      $('#div1 img').removeClass("scaleup");
      $('#div2 img.' + not_udd_id).addClass("scaleup");
    }
    function round_end (image) {
      $('#div2 img').removeClass("scaleup");
      $('#div1 img').removeClass("scaleup");
    }
    function rand (image_id) {
      new_image_id = Math.floor((Math.random() * 8) + 1);
      if (new_image_id == image_id) {
        new_image_id = 9 - image_id
      };
      return new_image_id;
    }
  </script>


</body>
</html>
